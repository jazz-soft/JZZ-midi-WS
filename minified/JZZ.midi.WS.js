(e=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=e.WS=e:"function"==typeof define&&define.amd?define("JZZ.midi.WS",["JZZ"],e):e(JZZ)})(function(m){var e;function t(e){if(!(this instanceof t))return new t(e);(self=this).wss=e,this.cli=[],this.ins={},this.outs={},this.inputs=[],this.outputs=[],e.on("connection",function(e){((e,t)=>{for(var i=0;i<e.length;i++)if(e[i]==t)return;e.push(t)})(self.cli,e),e.on("error",console.error),e.on("message",function(e){try{var t=JSON.parse(e);t.midi&&self.outs[t.id]&&self.outs[t.id].send(v(t.midi))}catch(e){}}),e.on("close",function(){self.cli=((e,t)=>{for(var i=[],n=0;n<e.length;n++)e[n]!=t&&i.push(t);return i})(self.cli,e)}),e.send(n(self))})}function n(e){return JSON.stringify({info:{inputs:e.inputs,outputs:e.outputs}})}function o(e,t){for(var i=0;i<e.cli.length;i++)e.cli[i].send(t)}function g(e){for(var t={midi:e.splice(0,e.length)},i=Object.keys(e),n=0;n<i.length;n++)"length"!=i[n]&&"_from"!=i[n]&&(t[i[n]]=e[i[n]]);return t}function v(e){for(var t=new m.MIDI(e.midi),i=Object.keys(e),n=0;n<i.length;n++)"midi"!=i[n]&&(t[i[n]]=i[i[n]]);return t}function y(e,t){for(var i=[],n=[],o=0;o<e.length;o++)t.includes(e[o])||i.push(e[o]);for(o=0;o<t.length;o++)e.includes(t[o])||n.push(t[o]);return[i,n]}m.WS||(e="undefined"==typeof WebSocket?require("ws"):WebSocket,t.prototype.addMidiIn=function(t,e){var i;this.ins[t]||(this.ins[t]=e,this.inputs.push(t),i=this,e.connect(function(e){o(i,JSON.stringify({id:t,midi:g(e)}))}),o(this,n(this)))},t.prototype.addMidiOut=function(e,t){this.outs[e]||(this.outs[e]=t,this.outputs.push(e),o(this,n(this)))},t.prototype.removeMidiIn=function(e){var t=this.inputs.indexOf(e);-1!=t&&(this.inputs.splice(t,1),this.ins[e].disconnect(),delete this.ins[e],o(this,n(this)))},t.prototype.removeMidiOut=function(e){var t=this.outputs.indexOf(e);-1!=t&&(this.outputs.splice(t,1),this.outs[e].disconnect(),delete this.outs[e],o(this,n(this)))},m.WS={connect:function(s,r){function t(){try{(u=new e(s)).onerror=function(e){a||console.error(e),a=!0},u.onclose=function(){for(var e=0;e<h.length;e++)d[h[e]].disconnect(),m.removeMidiIn(s+" - "+h[e]);for(e=0;e<l.length;e++)f[l[e]].disconnect(),m.removeMidiOut(s+" - "+l[e]);d={},f={},h=[],l=[],i||setTimeout(t,1e3)},u.onmessage=function(e){r&&(clearTimeout(r),r=void 0),a=!1;try{var t=JSON.parse(e.data);if(t.info){for(var i,n=y(t.info.inputs,h),o=0;o<n[0].length;o++)i=new m.Widget,d[n[0][o]]=i,m.addMidiIn(s+" - "+n[0][o],i);for(o=0;o<n[1].length;o++)d[n[1][o]].disconnect(),delete d[n[1][o]],m.removeMidiIn(s+" - "+n[1][o]);for(n=y(t.info.outputs,l),o=0;o<n[0].length;o++)i=new m.Widget({_receive:((t,i)=>function(e){t.send(JSON.stringify({id:i,midi:g(e)}))})(u,n[0][o])}),f[n[0][o]]=i,m.addMidiOut(s+" - "+n[0][o],i);for(o=0;o<n[1].length;o++)f[n[1][o]].disconnect(),delete f[n[1][o]],m.removeMidiOut(s+" - "+n[1][o]);h=t.info.inputs,l=t.info.outputs,p&&(p=!1,c._resume())}else t.midi&&d[t.id]&&d[t.id].send(v(t.midi))}catch(e){console.error(e.message)}}}catch(e){console.error(e.message),c._crash()}}var u,c=new m.lib.R,d={},f={},h=[],l=[],p=!0,i=!1,a=!1;return r=r==parseInt(r)&&0<r?r:5e3,r=setTimeout(function(){p&&(c._crash(),i=!0)},r),c._close=function(){i=!0,u&&u.close()},t(),c._thenable()},decode:v,encode:g,Server:t})});