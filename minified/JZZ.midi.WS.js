(i=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=i.WS=i:"function"==typeof define&&define.amd?define("JZZ.midi.WS",["JZZ"],i):i(JZZ)})(function(m){var i;function t(i){if(!(this instanceof t))return new t(i);var e=this;this.wss=i,this.cli=[],this.ins={},this.outs={},this.inputs=[],this.outputs=[],i.on("connection",function(i){((i,t)=>{for(var e=0;e<i.length;e++)if(i[e]==t)return;i.push(t)})(e.cli,i),i.on("error",console.error),i.on("message",function(i){try{var t=JSON.parse(i);t.midi&&e.outs[t.id]&&e.outs[t.id].send(v(t.midi))}catch(i){}}),i.on("close",function(){e.cli=((i,t)=>{for(var e=[],n=0;n<i.length;n++)i[n]!=t&&e.push(t);return e})(e.cli,i)}),i.send(n(e))})}function n(i){return JSON.stringify({info:{inputs:i.inputs,outputs:i.outputs}})}function o(i,t){for(var e=0;e<i.cli.length;e++)i.cli[e].send(t)}function g(i){for(var t={midi:i.splice(0,i.length)},e=Object.keys(i),n=0;n<e.length;n++)"length"!=e[n]&&"_from"!=e[n]&&(t[e[n]]=i[e[n]]);return t}function v(i){for(var t=new m.MIDI(i.midi),e=Object.keys(i),n=0;n<e.length;n++)"midi"!=e[n]&&(t[e[n]]=e[e[n]]);return t}function y(i,t){for(var e=[],n=[],o=0;o<i.length;o++)t.includes(i[o])||e.push(i[o]);for(o=0;o<t.length;o++)i.includes(t[o])||n.push(t[o]);return[e,n]}m.WS||(i="undefined"==typeof WebSocket?require("ws"):WebSocket,t.prototype.addMidiIn=function(t,i){var e;this.ins[t]||(this.ins[t]=i,this.inputs.push(t),e=this,i.connect(function(i){o(e,JSON.stringify({id:t,midi:g(i)}))}),o(this,n(this)))},t.prototype.addMidiOut=function(i,t){this.outs[i]||(this.outs[i]=t,this.outputs.push(i),o(this,n(this)))},t.prototype.removeMidiIn=function(i){var t=this.inputs.indexOf(i);-1!=t&&(this.inputs.splice(t,1),this.ins[i].disconnect(),delete this.ins[i],o(this,n(this)))},t.prototype.removeMidiOut=function(i){var t=this.outputs.indexOf(i);-1!=t&&(this.outputs.splice(t,1),this.outs[i].disconnect(),delete this.outs[i],o(this,n(this)))},m.WS={connect:function(s,r){function t(){try{(u=new i(s)).onerror=function(i){a||console.error(i),a=!0},u.onclose=function(){for(var i=0;i<h.length;i++)d[h[i]].disconnect(),m.removeMidiIn(s+" - "+h[i]);for(i=0;i<l.length;i++)f[l[i]].disconnect(),m.removeMidiOut(s+" - "+l[i]);d={},f={},h=[],l=[],e||setTimeout(t,1e3)},u.onmessage=function(i){r&&(m.lib.plug(c),clearTimeout(r),r=void 0),a=!1;try{var t=JSON.parse(i.data);if(t.info){for(var e,n=y(t.info.inputs,h),o=0;o<n[0].length;o++)e=new m.Widget({_info:{type:"ws"}}),d[n[0][o]]=e,m.addMidiIn(s+" - "+n[0][o],e);for(o=0;o<n[1].length;o++)d[n[1][o]].disconnect(),delete d[n[1][o]],m.removeMidiIn(s+" - "+n[1][o]);for(n=y(t.info.outputs,l),o=0;o<n[0].length;o++)e=new m.Widget({_receive:((t,e)=>function(i){t.send(JSON.stringify({id:e,midi:g(i)}))})(u,n[0][o]),_info:{type:"ws"}}),f[n[0][o]]=e,m.addMidiOut(s+" - "+n[0][o],e);for(o=0;o<n[1].length;o++)f[n[1][o]].disconnect(),delete f[n[1][o]],m.removeMidiOut(s+" - "+n[1][o]);h=t.info.inputs,l=t.info.outputs,p&&(p=!1,c._resume())}else t.midi&&d[t.id]&&d[t.id].send(v(t.midi))}catch(i){console.error(i.message)}}}catch(i){console.error(i.message),c._crash()}}var u,c=new m.lib.R,d={},f={},h=[],l=[],p=!0,e=!1,a=!1;return r=r==parseInt(r)&&0<r?r:5e3,r=setTimeout(function(){p&&(c._crash(),e=!0)},r),c._close=function(){e=!0,m.lib.unplug(c),u&&u.close()},t(),c._thenable()},decode:v,encode:g,Server:t})});