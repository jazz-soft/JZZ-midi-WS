(t=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t.WS=t:"function"==typeof define&&define.amd?define("JZZ.midi.WS",["JZZ"],t):t(JZZ)})(function(a){var n;function e(t){if(!(this instanceof e))return new e(t);(self=this).wss=t,this.cli=[],this.ins={},this.outs={},this.inputs=[],this.outputs=[],t.on("connection",function(t){((t,e)=>{for(var i=0;i<t.length;i++)if(t[i]==e)return;t.push(e)})(self.cli,t),t.on("error",console.error),t.on("message",function(t){try{var e=JSON.parse(t);e.midi&&self.outs[e.id]&&self.outs[e.id].send(g(e.midi))}catch(t){}}),t.on("close",function(){self.cli=((t,e)=>{for(var i=[],n=0;n<t.length;n++)t[n]!=e&&i.push(e);return i})(self.cli,t)}),t.send(o(self))})}function o(t){return JSON.stringify({info:{inputs:t.inputs,outputs:t.outputs}})}function s(t,e){for(var i=0;i<t.cli.length;i++)t.cli[i].send(e)}function m(t){for(var e={midi:t.splice(0,t.length)},i=Object.keys(t),n=0;n<i.length;n++)"length"!=i[n]&&"_from"!=i[n]&&(e[i[n]]=t[i[n]]);return e}function g(t){for(var e=new a.MIDI(t.midi),i=Object.keys(t),n=0;n<i.length;n++)"midi"!=i[n]&&(e[i[n]]=i[i[n]]);return e}function v(t,e){for(var i=[],n=[],o=0;o<t.length;o++)e.includes(t[o])||i.push(t[o]);for(o=0;o<e.length;o++)t.includes(e[o])||n.push(e[o]);return[i,n]}a.WS||(n="undefined"==typeof WebSocket?require("ws"):WebSocket,e.prototype.addMidiIn=function(e,t){var i;this.ins[e]||(this.ins[e]=t,this.inputs.push(e),i=this,t.connect(function(t){s(i,JSON.stringify({id:e,midi:m(t)}))}),s(this,o(this)))},e.prototype.addMidiOut=function(t,e){this.outs[t]||(this.outs[t]=e,this.outputs.push(t),s(this,o(this)))},e.prototype.removeMidiIn=function(t){var e=this.inputs.indexOf(t);-1!=e&&(this.inputs.splice(e,1),this.ins[t].disconnect(),delete this.ins[t],s(this,o(this)))},e.prototype.removeMidiOut=function(t){var e=this.outputs.indexOf(t);-1!=e&&(this.outputs.splice(e,1),this.outs[t].disconnect(),delete this.outs[t],s(this,o(this)))},a.WS={connect:function(r,t){function e(){try{var s=new n(r);s.onerror=function(t){p||console.error(t),p=!0},s.onclose=function(){for(var t=0;t<f.length;t++)c[f[t]].disconnect(),a.removeMidiIn(r+" - "+f[t]);for(t=0;t<h.length;t++)d[h[t]].disconnect(),a.removeMidiOut(r+" - "+h[t]);c={},d={},f=[],h=[],i||setTimeout(e,1e3)},s.onmessage=function(t){p=!1;try{var e=JSON.parse(t.data);if(e.info){for(var i,n=v(e.info.inputs,f),o=0;o<n[0].length;o++)i=new a.Widget,c[n[0][o]]=i,a.addMidiIn(r+" - "+n[0][o],i);for(o=0;o<n[1].length;o++)c[n[1][o]].disconnect(),delete c[n[1][o]],a.removeMidiIn(r+" - "+n[1][o]);for(n=v(e.info.outputs,h),o=0;o<n[0].length;o++)i=new a.Widget({_receive:((e,i)=>function(t){e.send(JSON.stringify({id:i,midi:m(t)}))})(s,n[0][o])}),d[n[0][o]]=i,a.addMidiOut(r+" - "+n[0][o],i);for(o=0;o<n[1].length;o++)d[n[1][o]].disconnect(),delete d[n[1][o]],a.removeMidiOut(r+" - "+n[1][o]);f=e.info.inputs,h=e.info.outputs,l&&(l=!1,u._resume())}else e.midi&&c[e.id]&&c[e.id].send(g(e.midi))}catch(t){console.error(t.message)}}}catch(t){console.error(t.message),u._crash()}}var u=new a.lib.R,c={},d={},f=[],h=[],l=!0,i=!1,p=!1;return t=t==parseInt(t)&&0<t?t:5e3,setTimeout(function(){l&&(u._crash(),i=!0)},t),e(),u._thenable()},decode:g,encode:m,Server:e})});