(i=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=i.WS=i:"function"==typeof define&&define.amd?define("JZZ.midi.WS",["JZZ"],i):i(JZZ)})(function(h){var i;function t(i){if(!(this instanceof t))return new t(i);(self=this).wss=i,this.cli=[],this.ins={},this.outs={},this.inputs=[],this.outputs=[],i.on("connection",function(i){((i,t)=>{for(var n=0;n<i.length;n++)if(i[n]==t)return;i.push(t)})(self.cli,i),i.on("error",console.error),i.on("message",function(i){try{var t=JSON.parse(i);t.midi&&self.outs[t.id]&&self.outs[t.id].send(p(t.midi))}catch(i){}}),i.on("close",function(){self.cli=((i,t)=>{for(var n=[],e=0;e<i.length;e++)i[e]!=t&&n.push(t);return n})(self.cli,i)}),i.send(e(self))})}function e(i){return JSON.stringify({info:{inputs:i.inputs,outputs:i.outputs}})}function s(i,t){for(var n=0;n<i.cli.length;n++)i.cli[n].send(t)}function l(i){for(var t={midi:i.splice(0,i.length)},n=Object.keys(i),e=0;e<n.length;e++)"length"!=n[e]&&"_from"!=n[e]&&(t[n[e]]=i[n[e]]);return t}function p(i){for(var t=new h.MIDI(i.midi),n=Object.keys(i),e=0;e<n.length;e++)"midi"!=n[e]&&(t[n[e]]=n[n[e]]);return t}function a(i,t){for(var n=[],e=[],s=0;s<i.length;s++)t.includes(i[s])||n.push(i[s]);for(s=0;s<t.length;s++)i.includes(t[s])||e.push(t[s]);return[n,e]}h.WS||(i="undefined"==typeof WebSocket?require("ws"):WebSocket,t.prototype.addMidiIn=function(t,i){var n;this.ins[t]||(this.ins[t]=i,this.inputs.push(t),n=this,i.connect(function(i){s(n,JSON.stringify({id:t,midi:l(i)}))}),s(this,e(this)))},t.prototype.addMidiOut=function(i,t){this.outs[i]||(this.outs[i]=t,this.outputs.push(i),s(this,e(this)))},t.prototype.removeMidiIn=function(i){var t=this.inputs.indexOf(i);1!=t&&(this.inputs.splice(t,1),this.ins[i].disconnect(),delete this.ins[i],s(this,e(this)))},t.prototype.removeMidiOut=function(i){var t=this.outputs.indexOf(i);1!=t&&(this.outputs.splice(t,1),this.outs[i].disconnect(),delete this.outs[i],s(this,e(this)))},h.WS={connect:function(o){var r=new i(o),u={},d={},c=[],f=[];r.onerror=console.error,r.onclose=function(){for(var i=0;i<c.length;i++)u[c[i]].disconnect(),h.removeMidiIn(o+" - "+c[i]);for(i=0;i<f.length;i++)d[f[i]].disconnect(),h.removeMidiOut(o+" - "+f[i]);u={},d={},c=[],f=[]},r.onmessage=function(i){try{var t=JSON.parse(i.data);if(t.info){for(var n,e=a(t.info.inputs,c),s=0;s<e[0].length;s++)n=new h.Widget,u[e[0][s]]=n,h.addMidiIn(o+" - "+e[0][s],n);for(s=0;s<e[1].length;s++)u[e[1][s]].disconnect(),delete u[e[1][s]],h.removeMidiIn(o+" - "+e[1][s]);for(e=a(t.info.outputs,f),s=0;s<e[0].length;s++)n=new h.Widget({_receive:((t,n)=>function(i){t.send(JSON.stringify({id:n,midi:l(i)}))})(r,e[0][s])}),d[e[0][s]]=n,h.addMidiOut(o+" - "+e[0][s],n);for(s=0;s<e[1].length;s++)d[e[1][s]].disconnect(),delete d[e[1][s]],h.removeMidiOut(o+" - "+e[1][s]);c=t.info.inputs,f=t.info.outputs}else t.midi&&u[t.id]&&u[t.id].send(p(t.midi))}catch(i){console.error(i.message)}}},Server:t})});