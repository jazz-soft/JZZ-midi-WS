(e=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=e.WS=e:"function"==typeof define&&define.amd?define("JZZ.midi.WS",["JZZ"],e):e(JZZ)})(function(m){var e;function i(e){if(!(this instanceof i))return new i(e);(self=this).wss=e,this.cli=[],this.ins={},this.outs={},this.inputs=[],this.outputs=[],e.on("connection",function(e){((e,i)=>{for(var t=0;t<e.length;t++)if(e[t]==i)return;e.push(i)})(self.cli,e),e.on("error",console.error),e.on("message",function(e){try{var i=JSON.parse(e);i.midi&&self.outs[i.id]&&self.outs[i.id].send(v(i.midi))}catch(e){}}),e.on("close",function(){self.cli=((e,i)=>{for(var t=[],n=0;n<e.length;n++)e[n]!=i&&t.push(i);return t})(self.cli,e)}),e.send(n(self))})}function n(e){return JSON.stringify({info:{inputs:e.inputs,outputs:e.outputs}})}function o(e,i){for(var t=0;t<e.cli.length;t++)e.cli[t].send(i)}function g(e){for(var i={midi:e.splice(0,e.length)},t=Object.keys(e),n=0;n<t.length;n++)"length"!=t[n]&&"_from"!=t[n]&&(i[t[n]]=e[t[n]]);return i}function v(e){for(var i=new m.MIDI(e.midi),t=Object.keys(e),n=0;n<t.length;n++)"midi"!=t[n]&&(i[t[n]]=t[t[n]]);return i}function y(e,i){for(var t=[],n=[],o=0;o<e.length;o++)i.includes(e[o])||t.push(e[o]);for(o=0;o<i.length;o++)e.includes(i[o])||n.push(i[o]);return[t,n]}m.WS||(e="undefined"==typeof WebSocket?require("ws"):WebSocket,i.prototype.addMidiIn=function(i,e){var t;this.ins[i]||(this.ins[i]=e,this.inputs.push(i),t=this,e.connect(function(e){o(t,JSON.stringify({id:i,midi:g(e)}))}),o(this,n(this)))},i.prototype.addMidiOut=function(e,i){this.outs[e]||(this.outs[e]=i,this.outputs.push(e),o(this,n(this)))},i.prototype.removeMidiIn=function(e){var i=this.inputs.indexOf(e);-1!=i&&(this.inputs.splice(i,1),this.ins[e].disconnect(),delete this.ins[e],o(this,n(this)))},i.prototype.removeMidiOut=function(e){var i=this.outputs.indexOf(e);-1!=i&&(this.outputs.splice(i,1),this.outs[e].disconnect(),delete this.outs[e],o(this,n(this)))},m.WS={connect:function(s,r){function i(){try{(u=new e(s)).onerror=function(e){a||console.error(e),a=!0},u.onclose=function(){for(var e=0;e<h.length;e++)d[h[e]].disconnect(),m.removeMidiIn(s+" - "+h[e]);for(e=0;e<l.length;e++)f[l[e]].disconnect(),m.removeMidiOut(s+" - "+l[e]);d={},f={},h=[],l=[],t||setTimeout(i,1e3)},u.onmessage=function(e){r&&(m.lib.plug(c),clearTimeout(r),r=void 0),a=!1;try{var i=JSON.parse(e.data);if(i.info){for(var t,n=y(i.info.inputs,h),o=0;o<n[0].length;o++)t=new m.Widget,d[n[0][o]]=t,m.addMidiIn(s+" - "+n[0][o],t);for(o=0;o<n[1].length;o++)d[n[1][o]].disconnect(),delete d[n[1][o]],m.removeMidiIn(s+" - "+n[1][o]);for(n=y(i.info.outputs,l),o=0;o<n[0].length;o++)t=new m.Widget({_receive:((i,t)=>function(e){i.send(JSON.stringify({id:t,midi:g(e)}))})(u,n[0][o])}),f[n[0][o]]=t,m.addMidiOut(s+" - "+n[0][o],t);for(o=0;o<n[1].length;o++)f[n[1][o]].disconnect(),delete f[n[1][o]],m.removeMidiOut(s+" - "+n[1][o]);h=i.info.inputs,l=i.info.outputs,p&&(p=!1,c._resume())}else i.midi&&d[i.id]&&d[i.id].send(v(i.midi))}catch(e){console.error(e.message)}}}catch(e){console.error(e.message),c._crash()}}var u,c=new m.lib.R,d={},f={},h=[],l=[],p=!0,t=!1,a=!1;return r=r==parseInt(r)&&0<r?r:5e3,r=setTimeout(function(){p&&(c._crash(),t=!0)},r),c._close=function(){t=!0,m.lib.unplug(c),u&&u.close()},i(),c._thenable()},decode:v,encode:g,Server:i})});